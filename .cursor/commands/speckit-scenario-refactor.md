# Spec-Kit Scenario: Major Refactor

引导用户对已有功能进行大规模重构或迁移。

---

## 场景识别

此场景适用于：
- `specs/{feature}/` 目录已存在
- 涉及破坏性变更
- 需要修改现有接口签名
- 需要数据库结构重大调整
- 需要数据迁移

---

## 工作流

按照 `@.specify/workflows/scenario-4-refactor.md` 中的定义执行。

### Step 1: 审查现有文档

1. 阅读现有文档并标记：
   - ✅ 保留：仍然有效的内容
   - ⚠️ 修改：需要调整的内容
   - ❌ 删除：不再需要的内容
   - 🆕 新增：需要补充的内容

2. 创建审查报告
3. 评估迁移复杂度

### Step 2: 创建 v2 版本目录

创建版本化目录结构：

```bash
specs/{feature}/
├── v1/                    # 旧版本（保留作为参考）
│   ├── spec.md
│   ├── plan.md
│   └── tasks.md
└── v2/                    # 新版本
    ├── spec.md
    ├── plan.md
    ├── tasks.md
    └── migration.md       # 迁移指南
```

### Step 3: 重新设计 spec.md

创建 `specs/{feature}/v2/spec.md`：

```markdown
# Feature: {Name} v2.0

> **Previous Version**: [v1](../v1/spec.md)

## 变更概述

### 从 v1 变更内容
| 类型 | 变更 |
|------|------|
| ✅ 保留 | ... |
| ⚠️ 修改 | ... |
| ❌ 删除 | ... |
| 🆕 新增 | ... |

### 破坏性变更
> ⚠️ **BREAKING CHANGES**
1. ...
```

**⚠️ 停止并等待用户确认**

### Step 4: 重新设计 plan.md

1. 设计新版本 API（版本号升级）
2. 设计数据库迁移脚本
3. 设计兼容层（如需要）

**⚠️ 停止并等待用户确认**

### Step 5: 创建迁移任务

创建 `specs/{feature}/v2/migration.md` 和 `tasks.md`：

1. **迁移指南**
   - 迁移步骤
   - 回滚方案
   - 验证清单

2. **迁移任务组**
   - 数据库迁移
   - 新接口实现
   - 兼容层
   - 旧接口废弃

**⚠️ 停止并等待用户确认**

### Step 6: 执行迁移

1. 备份数据库
2. 按任务顺序执行
3. 验证功能
4. 灰度发布

---

## 重构最佳实践

- 渐进式迁移，先部署兼容层
- 完善的回滚方案
- 充分的测试覆盖
- 通知下游用户

---

## Important

- 必须创建版本化目录结构
- 必须保留旧版本文档作为参考
- 必须列出所有破坏性变更
- 必须准备回滚方案
- 每个步骤完成后停止等待用户确认
